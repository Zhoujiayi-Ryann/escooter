<template>
  <view class="container">
	<view class="back-btn" @click="handleBack">
	  <van-icon name="arrow-left" class="back-icon"/>
	</view>
	  <view class="person-btn" @click="goToSettings" >
	    <van-icon name="manager" class="person-icon" />
	  </view>

<view class="map-container">
  <!-- åœ°å›¾å…ˆæ¸²æŸ“ -->
  <map
    id="orderMap"
    class="map"
    :latitude="location.lat"
    :longitude="location.lng"
    :markers="markers"
    :scale="16"
    show-location
    enable-3D
    enable-poi
    enable-overlooking
  />
  
  <!-- è¦†ç›–å±‚åæ¸²æŸ“ï¼Œç¡®ä¿é€æ˜ï¼Œä¸é˜»æŒ¡äº¤äº’ -->
  <cover-view class="map-overlay" />
</view>

    <!-- è®¢å•è¯¦æƒ…æµ®åŠ¨é¢æ¿ -->
    <van-floating-panel v-model:height="panelHeight" :anchors="anchors" class="floating-panel">
      <view class="order-details">
        <!-- è®¢å•æ ‡é¢˜ -->
    <view class="order-info">
      <text class="order-price">Completed</text>
      <view class="order-tags">
        <view class="badge">Order ID: {{ order.orderId }}</view>
        <view class="status-tag">Completed</view>
      </view>
    </view>

        <!-- è®¢å•ä¿¡æ¯ -->
        <view class="info-box">
				<view class="info-item">
				  <text class="label">Scooter ID:</text>
				  <text class="value">SC{{ order.scooterId }}</text>
				</view>
				<view class="info-item">
				  <text class="label">Start Time:</text>
				  <text class="value">{{ order.startTime }}</text>
				</view>
				<view class="info-item">
				  <text class="label">End Time:</text>
				  <text class="value">{{ order.endTime }}</text>
				</view>
				<view class="info-item">
				  <text class="label">Duration:</text>
				  <text class="value">{{ order.duration }}</text>
				</view>
				<view class="divider"></view>
				<view class="info-item">
				  <text class="label">Cost:</text>
				  <text class="value">ï¿¡{{ order.cost }}</text>
				</view>

		  
        </view>

        <!-- åé¦ˆæŒ‰é’® -->
        <view class="button-group">
          <van-button class="half-button home-btn" type="default" @click="goHome">
            Return Home
          </van-button>
          <van-button class="half-button feedback-btn" type="primary" @click="goToFeedback">
            Give Feedback
          </van-button>
        </view>
      </view>
    </van-floating-panel>
  </view>
</template>

<script setup>
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import { orderApi } from "@/utils/api/order";

const router = useRouter();

// ğŸš² è®¢å•ä¿¡æ¯
const order = ref({
  orderId: '',
  scooterId: '',
  startTime: '',
  endTime: '',
  duration: '',
  cost: 0,
  address: '',
});

// ğŸ“ åœ°å›¾ä½ç½®ï¼ˆåç§»ä¸­å¿ƒç‚¹ï¼‰
const location = ref({ lat: 0, lng: 0 });
// ğŸ“Œ åœ°å›¾æ ‡è®°
const markers = ref([]);

// æµ®åŠ¨é¢æ¿é«˜åº¦é”šç‚¹
const anchors = [
  120,
  Math.round(0.4 * window.innerHeight),
  Math.round(0.55 * window.innerHeight),
];
const panelHeight = ref(anchors[0]);

// æ—¶é—´æ ¼å¼åŒ– yyyy-MM-dd HH:mm
function formatToCST(utcStr) {
  if (!utcStr) return 'N/A';
  const date = new Date(utcStr);
  if (isNaN(date.getTime())) return 'Invalid Date';

  // è½¬ä¸ºä¸­å›½æ—¶é—´
  const offsetMs = 8 * 60 * 60 * 1000;
  const cstDate = new Date(date.getTime() + offsetMs);

  return `${cstDate.getFullYear()}-${(cstDate.getMonth() + 1).toString().padStart(2, '0')}-${cstDate.getDate().toString().padStart(2, '0')} ${cstDate.getHours().toString().padStart(2, '0')}:${cstDate.getMinutes().toString().padStart(2, '0')}`;
}

// è®¡ç®—æŒç»­æ—¶é—´ï¼ˆstart -> endï¼‰
function formatDuration(startStr, endStr) {
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end)) return 'Unknown';

  const diffMs = end - start;
  const totalMinutes = Math.floor(diffMs / (1000 * 60));
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return `${hours}h ${minutes}min`;
}

// âœ… è·å–è®¢å•è¯¦æƒ…
// const fetchOrderDetail = async () => {
//   const rawId = router.currentRoute.value.query.orderId;
//   const orderId = Number(rawId);

//   try {
//     const res = await orderApi.getOrderDetail(orderId);
//     if (res.code === 1 && res.data) {
//       const data = res.data;

//       order.value = {
//         orderId: data.order_id,
//         scooterId: data.scooter_id,
//         startTime: formatTime(data.start_time),
//         endTime: formatTime(data.end_time),
//         duration: formatDuration(data.start_time, data.end_time),
//         cost: data.cost ?? 0,
//         address: data.address || 'Unknown',
//       };

//       const lat = data.location_lat;
//       const lng = data.location_lng;

//       if (!lat || !lng) {
//         uni.showToast({ title: 'åæ ‡æ— æ•ˆ', icon: 'none' });
//         return;
//       }

//       location.value = { lat, lng };

//       markers.value = [{
//         id: 1,
//         latitude: lat,
//         longitude: lng,
//         iconPath: "/static/order_details/maker.svg",
//         width: 32,
//         height: 32,
//         callout: {
//           content: order.value.address || `Scooter SC${order.value.scooterId}`,
//           display: 'ALWAYS',
//           fontSize: 15,
//           borderRadius: 5,
//           padding: 5,
//           bgColor: "#ffffff",
//           color: "#007aff",
//         }
//       }];
//     }
//   } catch (e) {
//     uni.showToast({ title: 'ç½‘ç»œå¼‚å¸¸', icon: 'none' });
//   }
// };
const fetchOrderDetail = async () => {
  const rawId = router.currentRoute.value.query.orderId;
  const orderId = Number(rawId);
  if (!orderId || isNaN(orderId)) {
    uni.showToast({ title: 'è®¢å• ID æ— æ•ˆ', icon: 'none' });
    return;
  }

  try {
    const res = await orderApi.getOrderInfo(orderId);
    if (res.code === 1 && res.data) {
      const data = res.data;

      // ğŸ‘‡ ç¡®ä¿åç«¯å­—æ®µæ­£ç¡®
      const lat = data.scooter_info?.latitude;
      const lng = data.scooter_info?.longitude;

      // âœ… å¦‚æœåæ ‡ä¸ºç©ºï¼Œç»™å‡ºæç¤º
      if (!lat || !lng) {
        uni.showToast({ title: 'è½¦è¾†ä½ç½®ä¿¡æ¯æ— æ•ˆ', icon: 'none' });
        return;
      }

      order.value = {
        orderId: data.order_id,
        scooterId: data.scooter_id,
        startTime: formatToCST(data.start_time),
        endTime: formatToCST(data.end_time),
        duration: formatDuration(data.start_time, data.end_time),
        cost: data.cost ?? 0,
        address: data.address || 'Unknown',
		scooterLocation: data.pickup_address || 'Unknown',
      };

      // âœ… æ­£ç¡®è®¾ç½® location
      location.value = {
        lat,
        lng
      };

      loadScooterLocation();
    } else {
      uni.showToast({ title: res.msg || 'è®¢å•è·å–å¤±è´¥', icon: 'none' });
    }
  } catch (err) {
    console.error('ğŸš¨ ç½‘ç»œå¼‚å¸¸:', err);
    uni.showToast({ title: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•', icon: 'none' });
  }
};


const loadScooterLocation = () => {
  if (!location.value.lat || !location.value.lng) return;

  markers.value = [{
    id: 1,
    latitude: location.value.lat,
    longitude: location.value.lng,
    iconPath: '/static/order_details/maker.svg', 
    width: 32,
    height: 32,
    callout: {
      // âœ… æ”¹è¿™é‡Œï¼šä½¿ç”¨ä¸é¡µé¢ä¸­ä¸€è‡´çš„åœ°å€
      content: order.value.scooterLocation,
      display: 'ALWAYS',
      fontSize: 15,
      borderRadius: 5,
      padding: 5,
      bgColor: "#ffffff",
      color: "#007aff"
    }
  }];
};

// ğŸ”™ è¿”å›æŒ‰é’®
const handleBack = () => {
  if (getCurrentPages().length > 1) {
    uni.navigateBack();
  } else {
    uni.reLaunch({ url: '/pages/home/home' });
  }
};

// ğŸ‘¤ è®¾ç½®å…¥å£
const goToSettings = () => {
  uni.navigateTo({ url: '/pages/settings/my_settings/my_settings' });
};

// ğŸ—£ åé¦ˆè·³è½¬
const goToFeedback = () => {
  uni.navigateTo({ url: '/pages/feedback/feedback' });
};
const goHome = () => {
  uni.reLaunch({ url: '/pages/home/home' });
};
// æŒ‚è½½æ—¶åŠ è½½æ•°æ®
onMounted(() => {
  fetchOrderDetail();
});
</script>



<style scoped>

.back-btn{
  position: absolute;
  top: 50rpx;
  left: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  background-color: #f4f8ff;
  border-radius: 25rpx;
  width: 80rpx;
  height: 80rpx;
}

.back-icon{
  font-size: 55rpx;  
  color: #0084ff;
}
.person-btn {
 position: absolute;
  top: 50rpx;
  right: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  background-color: #f4f8ff;
  border-radius: 25rpx;
  width: 80rpx;
  height: 80rpx;
}

.person-icon{
  font-size: 55rpx;  
  color: #0084ff;
}
/* åœ°å›¾å®¹å™¨ */
.map-container {
  width: 100%;
  height: 100vh;
  position: relative;
}

.map {
  width: 100%;
  height: 100%;
}

.map-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to bottom,
    rgba(0, 123, 255, 0.2) 0%,   /* é¡¶éƒ¨æµ…è“è‰² */
    rgba(0, 123, 255, 0.1) 50%,  /* ä¸­é—´æ›´é€æ˜ */
    rgba(255, 255, 255, 0) 100%  /* åº•éƒ¨å®Œå…¨é€æ˜ */
  );
  pointer-events: none; /* è®©åœ°å›¾ä»å¯äº¤äº’ */
  z-index: 2; /* ç¡®ä¿è’™å±‚åœ¨åœ°å›¾ä¸Šæ–¹ */
}

/* æµ®åŠ¨é¢æ¿ - ç£¨ç ‚ç»ç’ƒé£æ ¼ */
.floating-panel {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(15px);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
}

/* è®¢å•è¯¦æƒ… */
.order-details {
  padding: 20px;
}

/* è®¢å•ä¿¡æ¯æ  */
.order-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-direction: row;
  font-size: 16px;
  font-weight: bold;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.order-tags {
  display: flex;
  /* flex-direction: row; */
  align-items: center;
  gap: 10px;
}

.badge {
  background-color: #eee;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  color: #444;
}

.status-tag {
  background-color: #007aff;
  color: white;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 12px;
}
.order-price {
  font-size: 25px;
  font-weight: bold;
  color:#0079fe;
}

/* åé¦ˆæŒ‰é’® */
.feedback-icon {
  font-size: 24px;
  color: #007aff;
  cursor: pointer;
}

/* è®¢å•ä¿¡æ¯æ¡† */
.info-box {
  background: rgba(229, 231, 245, 0.5);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-radius: 15px;
  margin-top: 15px;
  border: 1px solid #82b1ff;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* æ¯è¡Œä¿¡æ¯ */
.info-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 8px;
}

/* ä¿¡æ¯æ ‡ç­¾ */
.label {
  font-size: 17px;
  color: #33;
  
  font-weight: bold;
}

/* ä¿¡æ¯å€¼ */
.value {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}
/* åˆ†å‰²çº¿ */
.divider {
  width: 100%;
  height: 1px;
  background-color: #ddd;
  margin: 25px 0;
}


/* åé¦ˆæŒ‰é’® */
.feedback-btn {
  border-radius: 25px;
  font-size: 34rpx;
  /* font-weight: bold; */
  height: 96rpx;
  background: linear-gradient(to right, #82b1ff, #007aff);
  color: white;
  box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
}

/* æŒ‰é’®ç‚¹å‡»åŠ¨ç”» */

.button-group {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  gap: 20rpx;
  margin-top: 20px;
}

.half-button {
  flex: 1;
  height: 96rpx;
  border-radius: 25px;
  font-size: 32rpx;
  font-weight: 500;
}
.half-button:active {
  transform: scale(0.98);
}

.home-btn{
	border-radius: 25px;
	font-size: 34rpx;
	/* font-weight: bold; */
	height: 96rpx;
	background: #e7edf1;
	color: #0084ff;
	border: 1px solid rgba(255, 255, 255, 0.3);
	border: 1px solid #82b1ff;
}
</style>
