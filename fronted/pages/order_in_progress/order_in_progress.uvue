<template>
  <view class="container">
    <view class="back-btn" @click="handleBack">
      <van-icon name="arrow-left" class="back-icon"/>
    </view>
    <view class="person-btn" @click="goToHelp">
      <van-icon name="chat" class="person-icon" />
    </view>

    <view class="map-container">
      <map
        class="map"
        :longitude="location.lng"
        :latitude="location.lat"
        :markers="markers"
        :scale="15"
        show-location
      />
    </view>
    <cover-view class="map-overlay" />

    <van-floating-panel v-model:height="panelHeight" :anchors="anchors" class="floating-panel">
      <view class="order-details">
		<view class="order-info">
		  <text class="order-price">In Progress</text>
		  <view class="order-tags">
			<view class="badge">Order ID: {{ order.orderId }}</view>
			<view class="status-tag">In Progress</view>
		  </view>
		</view>


        <view class="info-box">
          <view class="info-item"><text class="label">Order ID:</text><text class="value">{{ order.orderId }}</text></view>
          <view class="info-item"><text class="label">Scooter ID:</text><text class="value">{{ order.scooterId }}</text></view>
          <view class="info-item"><text class="label">Scooter Location:</text><text class="value">{{ order.scooterLocation }}</text></view>
          <view class="info-item"><text class="label">Battery:</text><text class="value">{{ order.battery }}%</text></view>
          <view class="info-item"><text class="label">Usage Time:</text><text class="value">{{ order.duration }}</text></view>
          <view class="divider"></view>
          <view class="info-item"><text class="label">Price:</text><text class="value">${{ order.cost }}</text></view>
        </view>

        <van-button class="feedback-btn" type="primary" @click="goToReturn">
          Go to return vehicle
        </van-button>
      </view>
    </van-floating-panel>
  </view>
</template>

<script setup>
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import { orderApi } from "@/utils/api/order";

const router = useRouter();

const order = ref({
  orderId: '',
  scooterId: '',
  scooterLocation: '',
  battery: 0,
  duration: '',
  cost: 0
});

const location = ref({ lng: 0, lat: 0 });
const markers = ref([]);
const anchors = [
  120,
  Math.round(0.4 * window.innerHeight), 
  Math.round(0.55 * window.innerHeight), 
];
const panelHeight = ref(anchors[0]);

// ğŸ” åŠ è½½è®¢å•è¯¦æƒ…
onMounted(async () => {
  const rawId = router.currentRoute.value.query.orderId;
  const orderId = Number(rawId);

  if (!orderId) {
    uni.showToast({ title: 'è®¢å• ID æ— æ•ˆ', icon: 'none' });
    return;
  }

  try {
    const res = await orderApi.getOrderDetail(orderId);
    if (res.code === 1 && res.data) {
      const data = res.data;
      order.value = {
        orderId: data.order_id,
        scooterId: data.scooter_id,
        scooterLocation: data.address || 'Unknown', // åŸpickup_addressç»Ÿä¸€ä¸ºaddresså­—æ®µ
        battery: data.battery_level || 0,
        duration: `${data.duration} hour`,  // åç«¯å•ä½æ˜¯åˆ†é’Ÿ
        cost: data.cost || 0
      };

      location.value = {
        lat: data.location_lat,
        lng: data.location_lng
      };

      loadPositions(); // âœ… æ¸²æŸ“åœ°å›¾
    } else {
      uni.showToast({ title: res.msg || 'è®¢å•è·å–å¤±è´¥', icon: 'none' });
    }
  } catch (err) {
    console.error('âŒ è·å–è®¢å•å‡ºé”™:', err);
    uni.showToast({ title: 'ç½‘ç»œå¼‚å¸¸', icon: 'none' });
  }
});

// ğŸ•“ æ ¼å¼åŒ–éª‘è¡Œæ—¶é•¿ï¼ˆç§’ -> HH:mm:ssï¼‰
const formatDuration = (seconds) => {
  const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
  const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
};

// ğŸ—ºï¸ æ¸²æŸ“åœ°å›¾æ ‡è®°
const loadPositions = () => {
  markers.value = [
    {
      id: 1,
      latitude: location.value.lat,
      longitude: location.value.lng,
      iconPath: "/static/order_details/user_marker.png",
      width: 30,
      height: 30
    },
    {
      id: 2,
      latitude: location.value.lat + 0.0008,
      longitude: location.value.lng + 0.0005,
      iconPath: "/static/order_details/scooter_marker.png",
      width: 30,
      height: 30
    }
  ];
};

// ğŸ”™ è¿”å›é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªé¡µé¢å°±è·³é¦–é¡µ
const handleBack = () => {
  if (getCurrentPages().length > 1) {
    uni.navigateBack();
  } else {
    uni.reLaunch({
      url: '/pages/home/home'
    });
  }
};
const goToHelp = () => {
  uni.navigateTo({ url: '/pages/help/help' });
};
// ğŸ“¦ å»è¿˜è½¦é¡µé¢
const goToReturn = () => {
  if (!order.value.orderId) {
    uni.showToast({ title: 'è®¢å• ID ç¼ºå¤±', icon: 'none' });
    return;
  }
  uni.navigateTo({
    url: `/pages/return_confirm/return_confirm?orderId=${order.value.orderId}`
  });
};
</script>


<style scoped>

.back-btn{
  position: absolute;
  top: 50rpx;
  left: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  background-color: #f4f8ff;
  border-radius: 25rpx;
  width: 80rpx;
  height: 80rpx;
}

.back-icon{
  font-size: 55rpx;  
  color: #0084ff;
}
.person-btn {
 position: absolute;
  top: 50rpx;
  right: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  background-color: #f4f8ff;
  border-radius: 25rpx;
  width: 80rpx;
  height: 80rpx;
}

.person-icon{
  font-size: 55rpx;  
  color: #0084ff;
}


/* åœ°å›¾å®¹å™¨ */
.map-container {
  width: 100%;
  height: 100vh;
  position: relative;
}

.map {
  width: 100%;
  height: 100%;
}

.map-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to bottom,
    rgba(0, 123, 255, 0.2) 0%,   /* é¡¶éƒ¨æµ…è“è‰² */
    rgba(0, 123, 255, 0.1) 50%,  /* ä¸­é—´æ›´é€æ˜ */
    rgba(255, 255, 255, 0) 100%  /* åº•éƒ¨å®Œå…¨é€æ˜ */
  );
  pointer-events: none; /* è®©åœ°å›¾ä»å¯äº¤äº’ */
  z-index: 2; /* ç¡®ä¿è’™å±‚åœ¨åœ°å›¾ä¸Šæ–¹ */
}

/* æµ®åŠ¨é¢æ¿ - ç£¨ç ‚ç»ç’ƒé£æ ¼ */
.floating-panel {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(15px);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
}

/* è®¢å•è¯¦æƒ… */
.order-details {
  padding: 20px;
}

/* è®¢å•ä¿¡æ¯æ  */
.order-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-direction: row;
  font-size: 16px;
  font-weight: bold;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.order-tags {
  display: flex;
  /* flex-direction: row; */
  align-items: center;
  gap: 10px;
}

.badge {
  background-color: #eee;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  color: #444;
}

.status-tag {
  background-color: #007aff;
  color: white;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 12px;
}

.order-price {
  font-size: 25px;
  font-weight: bold;
  color:#0079fe;
}

/* åé¦ˆæŒ‰é’® */
.feedback-icon {
  font-size: 24px;
  color: #007aff;
  cursor: pointer;
}

/* è®¢å•ä¿¡æ¯æ¡† */
.info-box {
  background: rgba(229, 231, 245, 0.5);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-radius: 15px;
  margin-top: 15px;
  border: 1px solid #82b1ff;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* æ¯è¡Œä¿¡æ¯ */
.info-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 8px;
}

/* ä¿¡æ¯æ ‡ç­¾ */
.label {
  font-size: 17px;
  color: #33;
  
  font-weight: bold;
}

/* ä¿¡æ¯å€¼ */
.value {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}
/* åˆ†å‰²çº¿ */
.divider {
  width: 100%;
  height: 1px;
  background-color: #ddd;
  margin: 25px 0;
}


/* åé¦ˆæŒ‰é’® */
.feedback-btn {
  margin-top: 20px;
  width: 100%;
  border-radius: 25px;
  font-size: 34rpx;
  /* font-weight: bold; */
  height: 96rpx;
  background: linear-gradient(to right, #82b1ff, #007aff);
  color: white;
  box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
}

/* æŒ‰é’®ç‚¹å‡»åŠ¨ç”» */
.feedback-btn:active {
  transform: scale(0.98);
}
</style>

